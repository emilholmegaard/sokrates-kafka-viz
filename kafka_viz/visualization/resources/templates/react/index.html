<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Communication Visualization</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Load dependencies with reliable CDNs -->
    <script src="https://unpkg.com/react@17.0.2/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/d3@7.0.0/dist/d3.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.14.7/babel.min.js"></script>

    <!-- Add loading progress tracker -->
    <script>
        // Define loading states
        const LoadingStates = {
            LIBRARIES: { progress: 25, message: 'Loading libraries...' },
            DATA: { progress: 50, message: 'Loading visualization data...' },
            APP: { progress: 90, message: 'Initializing application...' },
            COMPLETE: { progress: 100, message: 'Ready!' }
        };

        function updateLoadingProgress(state) {
            const progress = document.getElementById('loading-progress');
            const status = document.getElementById('loading-status');
            const container = document.getElementById('loading-container');

            if (progress && status) {
                progress.style.width = `${state.progress}%`;
                status.textContent = state.message;

                if (state === LoadingStates.COMPLETE) {
                    setTimeout(() => {
                        container.style.display = 'none';
                    }, 1000);
                }
            }
        }

        // Make loading states globally available
        window.LoadingStates = LoadingStates;
        window.updateLoadingProgress = updateLoadingProgress;

        // Start with libraries state
        window.addEventListener('DOMContentLoaded', function() {
            updateLoadingProgress(LoadingStates.LIBRARIES);
        });
    </script>
</head>

<body>
    <div id="root"></div>

    <div id="loading-container">
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
        <div id="loading-status">Loading libraries...</div>
    </div>

    <!-- Debug Panel (hidden by default) -->
    <div id="debug-panel" style="display: none;">
        <div class="debug-header">
            <span>Debug Console</span>
            <button onclick="toggleDebug()">Hide</button>
        </div>
        <div id="debug-log"></div>
    </div>

    <!-- Debug Helper Script -->
    <script>
        // Toggle debug panel
        function toggleDebug() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Add keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.key === 'd' || e.key === 'D') {
                toggleDebug();
            }
        });

        // Simple debug log
        function logDebug(message) {
            console.log(message);
            const debugLog = document.getElementById('debug-log');
            if (debugLog) {
                const entry = document.createElement('div');
                entry.textContent = message;
                debugLog.appendChild(entry);
            }
        }

        // Override console methods to add to debug panel
        const originalConsole = {
            log: console.log,
            warn: console.warn,
            error: console.error
        };

        console.log = function(...args) {
            originalConsole.log.apply(console, args);
            logDebug('[LOG] ' + args.join(' '));
        };

        console.warn = function(...args) {
            originalConsole.warn.apply(console, args);
            logDebug('[WARN] ' + args.join(' '));
        };

        console.error = function(...args) {
            originalConsole.error.apply(console, args);
            logDebug('[ERROR] ' + args.join(' '));
            toggleDebug(); // Show debug on error
        };
    </script>

    <!-- Load data and app -->
    <script>
        // Check for required libraries
        window.addEventListener('load', function() {
            console.log('Checking dependencies...');
            
            if (typeof React === 'undefined') {
                console.error('React is not loaded!');
                return;
            }
            
            if (typeof ReactDOM === 'undefined') {
                console.error('ReactDOM is not loaded!');
                return;
            }
            
            if (typeof d3 === 'undefined') {
                console.error('D3 is not loaded!');
                return;
            }
            
            if (typeof Babel === 'undefined') {
                console.error('Babel is not loaded!');
                return;
            }
            
            console.log('All dependencies loaded successfully!');
            updateLoadingProgress(LoadingStates.DATA);
            
            // Load visualization data
            const dataScript = document.createElement('script');
            dataScript.src = 'visualization-data.js';
            
            dataScript.onload = function() {
                console.log('Visualization data loaded');
                
                if (!window.visualizationData) {
                    console.error('Visualization data not defined!');
                    return;
                }
                
                updateLoadingProgress(LoadingStates.APP);
                
                // Load the app script
                const appScript = document.createElement('script');
                appScript.type = 'text/babel';
                appScript.src = 'app.js';
                
                appScript.onload = function() {
                    console.log('App script loaded!');
                };
                
                appScript.onerror = function(error) {
                    console.error('Failed to load app script:', error);
                };
                
                document.body.appendChild(appScript);
            };
            
            dataScript.onerror = function(error) {
                console.error('Failed to load visualization data:', error);
            };
            
            document.body.appendChild(dataScript);
        });
    </script>
</body>

</html>
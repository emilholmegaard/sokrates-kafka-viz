<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <!-- Fix viewport meta tag -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Communication Visualization</title>
    <link rel="stylesheet" href="styles.css">

    <!-- Add Content Security Policy for workers -->
    <meta http-equiv="Content-Security-Policy"
        content="worker-src 'self' blob:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; connect-src 'self' https:;">

    <!-- Load Web Worker -->
    <script>
        // Add worker initialization with message handling
        function initWorker() {
            if (window.Worker) {
                try {
                    window.simulationWorker = new Worker('simulation.worker.js');
                    console.log('Simulation worker initialized');

                    // Add message handler for worker
                    window.simulationWorker.onmessage = function (e) {
                        console.log('Worker message:', e.data.type);
                        if (e.data.type === 'tick') {
                            // Update visualization on tick
                            if (window.updateVisualization) {
                                window.updateVisualization(e.data.nodes, e.data.links);
                            }
                        } else if (e.data.type === 'end') {
                            console.log('Simulation completed');
                            updateLoadingProgress(LoadingStates.COMPLETE);
                        }
                    };

                    window.simulationWorker.onerror = function (error) {
                        console.error('Worker error:', error);
                        updateLoadingProgress({
                            progress: 0,
                            message: 'Error: Simulation failed'
                        });
                    };

                    return true;
                } catch (error) {
                    console.error('Failed to initialize worker:', error);
                    return false;
                }
            }
            console.warn('Web Workers not supported');
            return false;
        }
    </script>

    <!-- Load dependencies with fallback CDNs -->
    <script>
        // Library definitions with versions and fallbacks
        const LIBRARIES = {
            babel: {
                version: '7.23.8',
                urls: [
                    'https://unpkg.com/@babel/standalone@7.23.8/babel.min.js',
                    'https://cdn.jsdelivr.net/npm/@babel/standalone@7.23.8/babel.min.js',
                    'https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.8/babel.min.js'
                ]
            },
            react: {
                version: '17.0.2',
                urls: [
                    'https://unpkg.com/react@17.0.2/umd/react.development.js',
                    'https://cdn.jsdelivr.net/npm/react@17.0.2/umd/react.development.js'
                ]
            },
            reactDom: {
                version: '17.0.2',
                urls: [
                    'https://unpkg.com/react-dom@17.0.2/umd/react-dom.development.js',
                    'https://cdn.jsdelivr.net/npm/react-dom@17.0.2/umd/react-dom.development.js'
                ]
            },
            d3: {
                version: '7.0.0',
                urls: [
                    'https://unpkg.com/d3@7.0.0/dist/d3.min.js',
                    'https://cdn.jsdelivr.net/npm/d3@7.0.0/dist/d3.min.js'
                ]
            }
        };

        // Improved script loader with timeout
        function loadScriptWithFallbacks(urls, timeout = 5000) {
            if (!urls.length) {
                return Promise.reject(new Error('All CDNs failed'));
            }

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = urls[0];

                const timeoutId = setTimeout(() => {
                    console.warn(`Timeout loading ${urls[0]}, trying next fallback...`);
                    script.remove();
                    loadScriptWithFallbacks(urls.slice(1), timeout)
                        .then(resolve)
                        .catch(reject);
                }, timeout);

                script.onload = () => {
                    clearTimeout(timeoutId);
                    resolve();
                };

                script.onerror = () => {
                    clearTimeout(timeoutId);
                    script.remove();
                    loadScriptWithFallbacks(urls.slice(1), timeout)
                        .then(resolve)
                        .catch(reject);
                };

                document.head.appendChild(script);
            });
        }

        // Add loading progress tracker
        const LoadingStates = {
            LIBRARIES: { progress: 25, message: 'Loading libraries...' },
            BABEL: { progress: 50, message: 'Loading Babel...' },
            DATA: { progress: 75, message: 'Loading visualization data...' },
            APP: { progress: 90, message: 'Initializing application...' },
            COMPLETE: { progress: 100, message: 'Ready!' }
        };

        function updateLoadingProgress(state) {
            const progress = document.getElementById('loading-progress');
            const status = document.getElementById('loading-status');
            const container = document.getElementById('loading-container');

            if (progress && status) {
                progress.style.width = `${state.progress}%`;
                status.textContent = state.message;

                if (state === LoadingStates.COMPLETE) {
                    setTimeout(() => {
                        container.style.display = 'none';
                    }, 1000);
                }
            }
        }

        // Update loadLibraries function
        async function loadLibraries() {
            try {
                updateLoadingProgress(LoadingStates.LIBRARIES);

                // Load Babel first
                await loadScriptWithFallbacks(LIBRARIES.babel.urls);
                updateLoadingProgress(LoadingStates.BABEL);
                console.log(`Babel v${LIBRARIES.babel.version} loaded`);

                // Load remaining libraries in parallel
                await Promise.all([
                    loadScriptWithFallbacks(LIBRARIES.react.urls),
                    loadScriptWithFallbacks(LIBRARIES.reactDom.urls),
                    loadScriptWithFallbacks(LIBRARIES.d3.urls)
                ]);

                // Initialize app after libraries are loaded
                initializeApp();
            } catch (error) {
                console.error('Failed to load libraries:', error);
                updateLoadingProgress({
                    progress: 0,
                    message: `Error: ${error.message}`
                });
            }
        }

        // Start loading libraries
        loadLibraries();
    </script>
</head>

<body>
    <div id="root"></div>

    <div id="loading-container">
        <div id="loading-bar">
            <div id="loading-progress"></div>
        </div>
        <div id="loading-status">Loading libraries...</div>
    </div>

    <!-- Debug Panel (hidden by default) -->
    <div id="debug-panel" style="display: none;">
        <div class="debug-header">
            <span>Debug Console</span>
            <span>
                <button id="console-toggle" onclick="toggleConsole()">Console: Off</button>
                <button onclick="clearDebug()">Clear</button>
                <button onclick="toggleDebug()">Hide</button>
            </span>
        </div>
        <div id="debug-log"></div>
    </div>

    <!-- Debug Helper Script -->
    <script>
        // Debug state initialization
        window.debugEnabled = true;
        window.consoleEnabled = true;
        window.debugLog = [];
        window.debugPanel = null;
        window.lastLogMessage = '';
        window.duplicateCount = 0;
        window.consoleEnabled = false; // Add console logging state

        // Add console toggle function
        function toggleConsole() {
            window.consoleEnabled = !window.consoleEnabled;
            console.log(`Console logging ${window.consoleEnabled ? 'enabled' : 'disabled'}`);

            // Update button text
            const toggleBtn = document.getElementById('console-toggle');
            if (toggleBtn) {
                toggleBtn.textContent = `Console: ${window.consoleEnabled ? 'On' : 'Off'}`;
            }
        }

        // Override console methods with toggle check
        const originalConsole = {
            log: console.log.bind(console),
            warn: console.warn.bind(console),
            error: console.error.bind(console)
        };

        console.log = function () {
            if (window.consoleEnabled) {
                logDebug('info', Array.from(arguments).join(' '));
            }
        };

        console.warn = function () {
            if (window.consoleEnabled) {
                logDebug('warning', Array.from(arguments).join(' '));
            }
        };

        console.error = function () {
            // Always show errors, even when console is disabled
            logDebug('error', Array.from(arguments).join(' '));
            if (window.duplicateCount === 1) {
                toggleDebug();
            }
        };

        // Initialize debug panel on load
        window.addEventListener('DOMContentLoaded', function () {
            window.debugPanel = document.getElementById('debug-panel');
            if (!window.debugPanel) {
                originalConsole.error('Debug panel element not found!');
            }
            // Keep debug panel hidden by default
            window.debugPanel.style.display = 'none';
        });

        // Enhanced debug toggle with error handling
        function toggleDebug() {
            try {
                const panel = document.getElementById('debug-panel');
                if (!panel) throw new Error('Debug panel not found');

                panel.style.display = panel.style.display === 'none' || panel.style.display === '' ? 'block' : 'none';
                window.debugEnabled = panel.style.display === 'block';
                console.log(`Debug panel ${window.debugEnabled ? 'enabled' : 'disabled'}`);
            } catch (error) {
                console.error('Error toggling debug panel:', error);
            }
        }

        function clearDebug() {
            document.getElementById('debug-log').innerHTML = '';
            window.debugLog = [];
        }

        // Log page load 
        console.log('Page loaded. Press D key to toggle debug panel.');

        // Add keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.key === 'd' || e.key === 'D') {
                toggleDebug();
            } else if (e.key === 'c' || e.key === 'C') {
                toggleConsole();
            }
        });

        // Enhanced dependency checking
        window.addEventListener('load', function () {
            console.log('Checking dependencies...');

            // Check required libraries
            const requiredDeps = {
                'React': typeof React !== 'undefined' ? React.version : undefined,
                'ReactDOM': typeof ReactDOM !== 'undefined' ? ReactDOM.version : undefined,
                'd3': typeof d3 !== 'undefined' ? d3.version : undefined,
                'Babel': typeof Babel !== 'undefined' ? 'loaded' : undefined
            };

            Object.entries(requiredDeps).forEach(([name, version]) => {
                if (!version) {
                    console.error(`${name} is not loaded!`);
                } else {
                    console.log(`${name} version: ${version}`);
                }
            });

            // Check visualization data with timeout
            setTimeout(function () {
                if (!window.visualizationData) {
                    console.error('visualization-data.js failed to load!');
                } else {
                    const data = window.visualizationData;
                    console.log('Data available:', {
                        nodes: data.nodes?.length || 0,
                        links: data.links?.length || 0,
                        schemas: data.schemas?.length || 0
                    });
                }
            }, 1000);
        });
    </script>

    <!-- Load data and app -->
    <script>
        function initializeApp() {
            updateLoadingProgress(LoadingStates.DATA);

            // Initialize worker first
            const workerAvailable = initWorker();
            console.log('Worker available:', workerAvailable);

            const dataScript = document.createElement('script');
            dataScript.src = 'visualization-data.js';

            dataScript.onload = () => {
                if (!window.visualizationData) {
                    console.error('Visualization data not loaded properly');
                    updateLoadingProgress({
                        progress: 0,
                        message: 'Error: Data loading failed'
                    });
                    return;
                }

                console.log('Data loaded:', {
                    nodes: window.visualizationData.nodes.length,
                    links: window.visualizationData.links.length
                });

                updateLoadingProgress(LoadingStates.APP);

                // Load app.js with Babel
                const appScript = document.createElement('script');
                appScript.type = 'text/babel';
                appScript.src = 'app.js';

                appScript.onload = () => {
                    console.log('App.js loaded, starting simulation');
                    if (workerAvailable && window.simulationWorker) {
                        // Start simulation in worker
                        window.simulationWorker.postMessage({
                            nodes: window.visualizationData.nodes,
                            links: window.visualizationData.links,
                            width: window.innerWidth,
                            height: window.innerHeight
                        });
                    } else {
                        // No worker, complete immediately
                        console.log('No worker available, completing directly');
                        updateLoadingProgress(LoadingStates.COMPLETE);
                    }
                };

                appScript.onerror = (error) => {
                    console.error('Failed to load app.js:', error);
                    updateLoadingProgress({
                        progress: 0,
                        message: 'Error: App loading failed'
                    });
                };

                document.body.appendChild(appScript);
            };

            dataScript.onerror = (error) => {
                console.error('Failed to load visualization-data.js:', error);
                updateLoadingProgress({
                    progress: 0,
                    message: 'Error: Data loading failed'
                });
            };

            document.body.appendChild(dataScript);
        }
    </script>
</body>

</html>